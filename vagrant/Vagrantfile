# -*- mode: ruby -*-
# vi: set ft=ruby :
Vagrant.require_version ">= 1.9.7"

Vagrant.configure("2") do |config|
  $setup_root = <<-SCRIPT
    set -e
    echo "[DEBUG] ******** setup root BASE VM"
    sudo cp /vagrant/apt-get /usr/local/sbin/
    export DEBIAN_FRONTEND=noninteractive
    echo "remove other users than ubuntu"
    sudo deluser --remove-home vagrant
    echo "Adding repositories and updating list"
    sudo add-apt-repository ppa:longsleep/golang-backports
    sudo apt-get update
    echo "Install packages"
    sudo apt-get install -y --no-remove ntp golang-1.9-go
    echo 'export PATH="/usr/lib/go-1.9/bin:$PATH"' >> ~/.profile
    . ~/.profile
  SCRIPT
  $cleanup_root = <<-SCRIPT
    echo "[DEBUG] ******** cleanup root BASE VM"
    apt-get autoremove --purge -y
    apt-get clean -y
    apt-get autoclean -y
    # Remove bash history
    unset HISTFILE
    rm -f /root/.bash_history
    # Cleanup log files
    find /var/log -type f | while read f; do echo -ne '' > $f; done;
    echo "Zeroing empty space"
    dd if=/dev/zero of=/tmp/EMPTY &>/dev/null || true
    rm -f /tmp/EMPTY
    echo "All clear."
  SCRIPT
  $setup_scion = <<-SCRIPT
    set -e
    echo "[DEBUG] ******** setup scion BASE VM"
    export DEBIAN_FRONTEND=noninteractive
    /vagrant/scion_install_script.sh -s /vagrant/scion.service -z /vagrant/scion-viz.service -a ~/.bash_aliases -u /vagrant/scionupgrade.sh -t /vagrant/scionupgrade -c
    . ~/.profile
    echo "Cleaning SCION things"
    cd $SC
    ./scion.sh stop
    rm $SC/logs/*
    rm -r $SC/gen
    echo "All done."
  SCRIPT
  config.vm.box = "SCIONLabVM-base"
  config.vm.provider "virtualbox" do |vb|
    vb.name = "SCIONLabVM-base"
    vb.customize [ "setextradata", :id, "VBoxInternal/Devices/VMMDev/0/Config/GetHostTimeDisabled", 1 ]
  end
  config.vm.provision "shell", privileged: false, run: "once", inline: $setup_root
  config.vm.provision "shell", privileged: false, run: "always", inline: $setup_scion
  config.vm.provision "shell", privileged: true, run: "once", inline: $cleanup_root
  config.ssh.username = "ubuntu"
  config.ssh.password = "788fdb157d4e230c601999e2"
  # https://github.com/hashicorp/vagrant/issues/5186
  config.ssh.insert_key = false
end
