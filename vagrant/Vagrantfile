# -*- mode: ruby -*-
# vi: set ft=ruby :
Vagrant.require_version ">= 1.9.7"

Vagrant.configure("2") do |config|
  $setup_root = <<-SCRIPT
    export DEBIAN_FRONTEND=noninteractive
    # install ntpd so we keep this box time-synchronized:
    update-locale LC_ALL=en_US.UTF-8 LANGUAGE=en_US.UTF-8
    apt-get update
    apt-get upgrade -y
    apt-get install -y --no-remove ntp
    adduser --gecos ",,," --disabled-password scion
    usermod -aG sudo scion
    usermod -aG adm scion
    echo 'scion ALL=(ALL) NOPASSWD:ALL' >/etc/sudoers.d/99-scion-user
  SCRIPT
  $cleanup_root = <<-SCRIPT
    apt-get autoremove --purge -y
    apt-get clean -y
    apt-get autoclean -y
    
    # Remove bash history
    unset HISTFILE
    rm -f /root/.bash_history
    rm -f /home/vagrant/.bash_history
    # Cleanup log files
    find /var/log -type f | while read f; do echo -ne '' > $f; done;
    dd if=/dev/zero of=/tmp/EMPTY &>/dev/null || true
    rm -f /tmp/EMPTY
    echo "All clear"
  SCRIPT
  $setup_scion = <<-SCRIPT
    export DEBIAN_FRONTEND=noninteractive
    # su scion -c '/vagrant/run_as_scion.sh'
    su scion -c '/vagrant/scion_install_script.sh -s /vagrant/scion.service -z /vagrant/scion-viz.service -a ~/.bash_aliases -u /vagrant/scionupgrade.sh -t /vagrant/scionupgrade -c'
  SCRIPT
  config.vm.box = "ubuntu/xenial64"
  config.vm.provider "virtualbox" do |vb|
    vb.name = "SCIONLabVM-base"
  end
  config.vm.provision "shell", privileged: true, run: "once", inline: $setup_root
  config.vm.provision "shell", privileged: true, run: "always", inline: $setup_scion
  config.vm.provision "shell", privileged: true, run: "always", inline: $cleanup_root
end
