# -*- mode: ruby -*-
# vi: set ft=ruby :
Vagrant.require_version ">= 1.8.1"

Vagrant.configure("2") do |config|
  $setup_root = <<-SCRIPT
    set -e
    echo "[DEBUG] setup bootstrap VM"
    export DEBIAN_FRONTEND=noninteractive
    update-locale LC_ALL=en_US.UTF-8 LANGUAGE=en_US.UTF-8
    usermod -aG sudo ubuntu
    usermod -aG adm ubuntu
    echo 'ubuntu ALL=(ALL) NOPASSWD:ALL' >/etc/sudoers.d/99-ubuntu-user
    echo ubuntu:788fdb157d4e230c601999e2 | chpasswd
    echo "Enable password authentication on sshd (backwards compatibility)"
    sed -i 's/PasswordAuthentication no/PasswordAuthentication yes/g' /etc/ssh/sshd_config
    systemctl restart sshd
  SCRIPT
  $cleanup_root = <<-SCRIPT
  echo "[DEBUG] cleanup bootstrap VM"
    set -e
    # Remove bash history
    unset HISTFILE
    rm -f /root/.bash_history
    rm -f /home/vagrant/.bash_history
    # Cleanup log files
    find /var/log -type f | while read f; do echo -ne '' > $f; done;
    echo "Bootstrap clear"
  SCRIPT
  config.vm.box = "ubuntu/xenial64"
  config.vm.provider "virtualbox" do |vb|
    vb.name = "SCIONLabVM-base"
  end
  config.vm.provision "shell", privileged: true, run: "once", inline: $setup_root
  config.vm.provision "shell", privileged: true, run: "once", inline: $cleanup_root
  # https://github.com/hashicorp/vagrant/issues/5186
  config.ssh.insert_key = false
end
